name: Push to AWS

on: [push]

jobs:
  PushAWS:
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        os: [ubuntu-18.04, macos-10.15, windows-2019]

    steps:
    - name: Clone Repository
      uses: actions/checkout@v2
    - name: Install Python 3.7
      uses: actions/setup-python@v2
      with:
        python-version: '3.7.7'
        architecture: 'x64'
    - name: Install Python Dependencies
      if: ((matrix.os == 'ubuntu-18.04') || (matrix.os == 'macos-10.15'))
      run: |
        sudo -H python3 -m pip install requests
        sudo -H python3 -m pip install beautifulsoup4
        sudo -H python3 -m pip install awscli
    - name: Install Python Dependencies
      if: (matrix.os == 'windows-2019')
      run: |
        python -m pip install requests
        python -m pip install beautifulsoup4
        python -m pip install awscli
    - name: Install Python Dependencies
      if: ((matrix.os == 'ubuntu-18.04') || (matrix.os == 'macos-10.15'))
      run: |
        sudo -H python3 -m pip install requests
        sudo -H python3 -m pip install beautifulsoup4
        sudo -H python3 -m pip install awscli
    - name: Processing Linux
      if: (matrix.os == 'ubuntu-18.04')
      run: |
        mkdir $GITHUB_WORKSPACE/temp
        cd $GITHUB_WORKSPACE/temp
        curl -O -L --insecure https://download.processing.org/processing-3.5.3-linux64.tgz
        tar -xzvf processing-3.5.3-linux64.tgz
        export PATH=$GITHUB_WORKSPACE/temp/processing-3.5.3:$PATH
        mkdir -p $HOME/sketchbook/libraries/
        cp -a $GITHUB_WORKSPACE/OpenBCI_GUI/libraries/. $HOME/sketchbook/libraries/
    - name: Processing MacOS
      if: (matrix.os == 'macos-10.15')
      run: |
        mkdir $GITHUB_WORKSPACE/temp
        cd $GITHUB_WORKSPACE/temp
        curl -O -L --insecure https://download.processing.org/processing-3.5.3-macosx.zip
        unzip processing-3.5.3-macosx.zip
        mv Processing.app /Applications/Processing.app
        export PATH=$GITHUB_WORKSPACE/release_script/mac_only:$PATH
        chmod +x $GITHUB_WORKSPACE/release_script/mac_only/processing-java
        mkdir -p $HOME/Documents/Processing/libraries/
        cp -a $GITHUB_WORKSPACE/OpenBCI_GUI/libraries/. $HOME/Documents/Processing/libraries/
        python -m pip install dmgbuild
        cp -a $GITHUB_WORKSPACE/OpenBCI_GUI/libraries/. $HOME/sketchbook/libraries/
    - name: Unix Testing Script
      if: ((matrix.os == 'macos-10.15') || (matrix.os == 'ubuntu-18'))
      run: |
        cd $GITHUB_WORKSPACE
        python $GITHUB_WORKSPACE/OpenBCI_GUI_UnitTests/run-unittests.py                                      ;fi
        python $GITHUB_WORKSPACE/release_script/make-release.py --no-prompts
        GUI_COMMIT_TIME=`cat temp/timestamp.txt`
        GUI_VERSION_STRING=`cat temp/versionstring.txt`
    - name: Windows Build Script
      if: (matrix.os == 'windows-2019')
      run: |
        cd %GITHUB_WORKSPACE%
        python %GITHUB_WORKSPACE%\OpenBCI_GUI_UnitTests\run-unittests.py
        python %GITHUB_WORKSPACE%\release_script\make-release.py --no-prompts --pfx-password %PFX_PASS% --pfx-path %GITHUB_WORKSPACE%\release_script\windows_only\84b241cb6d0bf5e6-SHA2.pfx
        set /p GUI_COMMIT_TIME= < temp\timestamp.txt
        set /p GUI_VERSION_STRING= < temp\versionstring.txt
    - name: MacOS Publish
      if: (matrix.os == 'macos-10.15')
      run: |
        aws s3 rm s3://openbci-gui/${GITHUB_REF}/latest  --recursive --exclude "*" --include "openbcigui_*_macosx.dmg"
        aws s3 cp $TRAVIS_BUILD_DIR/. s3://openbci-gui/${GITHUB_REF}/${GUI_VERSION_STRING}_${GUI_COMMIT_TIME}  --recursive --exclude "*" --include "openbcigui_*_macosx.dmg"
        aws s3 cp $TRAVIS_BUILD_DIR/. s3://openbci-gui/${GITHUB_REF}/latest  --recursive --exclude "*" --include "openbcigui_*_macosx.dmg"
    - name: Linux Publish
      if: (matrix.os == 'ubuntu-18')
      run: |
        aws s3 rm s3://openbci-gui/${GITHUB_REF}/latest  --recursive --exclude "*" --include "openbcigui_*_linux64.zip"
        aws s3 cp $GITHUB_WORKSPACE/. s3://openbci-gui/${GITHUB_REF}/${GUI_VERSION_STRING}_${GUI_COMMIT_TIME}  --recursive --exclude "*" --include "openbcigui_*_linux64.zip"
        aws s3 cp $GITHUB_WORKSPACE/. s3://openbci-gui/${GITHUB_REF}/latest  --recursive --exclude "*" --include "openbcigui_*_linux64.zip"
    - name: Windows Publish
      if: (matrix.os == 'windows-2019')
      run: |
        aws s3 rm s3://openbci-gui/%GITHUB_REF%/latest  --recursive --exclude "*" --include "openbcigui_*_windows64.zip"
        aws s3 cp %GITHUB_WORKSPACE%\. s3://openbci-gui/%GITHUB_REF%/%GUI_VERSION_STRING%_%GUI_COMMIT_TIME%  --recursive --exclude "*" --include "openbcigui_*_windows64.zip"
        aws s3 cp %GITHUB_WORKSPACE%\. s3://openbci-gui/%GITHUB_REF%/latest  --recursive --exclude "*" --include "openbcigui_*_windows64.zip"
        aws s3 cp %GITHUB_WORKSPACE%\release_script\index.html s3://openbci-gui/index.html
